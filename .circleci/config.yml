version: 2.1

orbs:
  aws-cli: circleci/aws-cli@5.1.2

executors:
  docker-executor:
    docker:
      - image: cimg/base:stable
    working_directory: ~/project

jobs:
  build_and_push_docker:
    executor: docker-executor
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - aws-cli/setup:
          role_arn: '${AWS_ECR_DEPLOY_ARN}'
          role_session_name: '${AWS_SESSION_NAME}'
          profile_name: ecr-publisher
      - checkout
      - attach_workspace:
          at: ~/project
      - run:
          name: Write Git SHA to version file
          command: |
            echo "VERSION=${CIRCLE_SHA1}" > version.txt
      - run:
          name: Build docker images
          command: |
            set -e
            docker build -t ${AWS_ECR_ACCOUNT}/fimento/hook0-api:latest --build-arg FEATURES="application-secret-compatibility" -f ./api/Dockerfile . &
            PID_API=$!
            docker build -t ${AWS_ECR_ACCOUNT}/fimento/hook0-frontend:latest -f ./frontend/Dockerfile . &
            PID_FRONTEND=$!
            docker build -t ${AWS_ECR_ACCOUNT}/fimento/hook0-output-worker:latest -f ./output-worker/Dockerfile . &
            PID_WORKER=$!
            FAIL=0
            wait $PID_API || FAIL=1
            wait $PID_FRONTEND || FAIL=1
            wait $PID_WORKER || FAIL=1
            if [ $FAIL -ne 0 ]; then echo "One or more Docker builds failed"; exit 1; fi
      - run:
          name: Authenticate to ECR
          command: |
            aws ecr get-login-password --region "${AWS_DEFAULT_REGION}" | docker login --username AWS "${AWS_ECR_ACCOUNT}" --password-stdin
      - run:
          name: Push to ECR
          command: |
            echo "Pushing Docker images..."
            docker tag "${AWS_ECR_ACCOUNT}/fimento/hook0-api:latest" "${AWS_ECR_ACCOUNT}/fimento/hook0-api:${CIRCLE_SHA1}"
            docker tag "${AWS_ECR_ACCOUNT}/fimento/hook0-frontend:latest" "${AWS_ECR_ACCOUNT}/fimento/hook0-frontend:${CIRCLE_SHA1}"
            docker tag "${AWS_ECR_ACCOUNT}/fimento/hook0-output-worker:latest" "${AWS_ECR_ACCOUNT}/fimento/hook0-output-worker:${CIRCLE_SHA1}"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-api:latest"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-api:${CIRCLE_SHA1}"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-frontend:latest"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-frontend:${CIRCLE_SHA1}"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-output-worker:latest"
            docker push "${AWS_ECR_ACCOUNT}/fimento/hook0-output-worker:${CIRCLE_SHA1}"
  update_k8s_image_and_sync:
    # This job updates the `image.tag` field in `k8s/{deploy_environment}.values.yaml`.
    # When updated, ArgoCD detects the change and deploys the specified image tag in
    # the corresponding Kubernetes environment.
    executor: docker-executor
    environment:
      AWS_DEFAULT_REGION: eu-north-1
      ECR_REGISTRY: 711387106999.dkr.ecr.eu-north-1.amazonaws.com
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Set Deploy Environment
          command: |
            echo 'export DEPLOY_ENVIRONMENT=sandbox' >> "${BASH_ENV}"
            echo "Set DEPLOY_ENVIRONMENT to 'sandbox'. Staging and production are not yet implemented."
      - run:
          name: Load Commit SHA
          command: |
            IMAGE_TAG="${CIRCLE_SHA1}"
            echo "export IMAGE_TAG=${IMAGE_TAG}" >> "${BASH_ENV}"
            echo "Using IMAGE_TAG: $IMAGE_TAG"
      - aws-cli/setup:
          role_arn: '${AWS_ROLE_ARN}'
          role_session_name: '${AWS_SESSION_NAME}'
      - run:
          name: Authenticate to ECR
          command: |
            aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin ${ECR_REGISTRY}
      - run:
          name: Verify Image Tags Exist in ECR
          command: |
            for REPO in fimento/hook0-api fimento/hook0-frontend fimento/hook0-output-worker; do
              IMAGE_EXISTS=$(aws ecr describe-images --region eu-north-1 --repository-name ${REPO} --image-ids imageTag=$IMAGE_TAG || echo "NOT_FOUND")
              if [ "$IMAGE_EXISTS" = "NOT_FOUND" ]; then
                echo "Error: Image with tag $IMAGE_TAG does not exist in repository $REPO. Exiting."
                exit 1
              fi
              echo "Image with tag $IMAGE_TAG exists in $REPO."
            done
      - run:
          name: Update image.tag in values.yaml
          command: |
            for VALUES_FILE in k8s/values.yaml k8s/values.demo.yaml; do
              yq -i ".api.image.tag = \"$IMAGE_TAG\"" "$VALUES_FILE"
              yq -i ".frontend.image.tag = \"$IMAGE_TAG\"" "$VALUES_FILE"
              yq -i ".outputWorker.image.tag = \"$IMAGE_TAG\"" "$VALUES_FILE"
            done
      - run:
          name: Commit and Push Updated Values File
          command: |
            # Save the bot key to a file
            touch ~/.ssh/botkey
            echo "-----BEGIN OPENSSH PRIVATE KEY-----" >> ~/.ssh/botkey
            echo "$FIMENTOBOT_KEY" >> ~/.ssh/botkey
            echo "-----END OPENSSH PRIVATE KEY-----" >> ~/.ssh/botkey
            echo "$FIMENTOBOT_KEY_PUB" > ~/.ssh/botkey.pub
            chmod 600 ~/.ssh/botkey
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            eval "$(ssh-agent -s)"
            ssh-add ~/.ssh/botkey

            # Configure Git to use the bot key for signing
            git config --global user.signingkey ~/.ssh/botkey
            git config --global gpg.format ssh
            git config --global commit.gpgSign true
            git config user.name "fimentobot"
            git config user.email "devops+circleci@fimento.com"
            CURRENT_BRANCH=$CIRCLE_BRANCH
            git add k8s/values*.yaml
            git commit -S -m "Update image.tag to ${IMAGE_TAG:0:8}... for $DEPLOY_ENVIRONMENT [skip ci]"
            git push origin $CURRENT_BRANCH

workflows:
  version: 2
  build_push_deploy:
    jobs:
      - build_and_push_docker:
          context: circleci-ecr-deploy
          filters:
            branches:
              only:
                - master
      - update_k8s_image_and_sync:
          requires:
            - build_and_push_docker
          context:
            - circleci-ecr-deploy
            - fimentobot-ci
          filters:
            branches:
              only:
                - master
